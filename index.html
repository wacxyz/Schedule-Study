<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Study Routine Tracker with Colored Subjects & Daily Notifications</title>
<style>
  /* (Your existing CSS unchanged, omitted here for brevity but please keep it same as above) */
  body {
    background: #f0f4f8;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 20px;
    color: #222;
    min-height: 100vh;
  }
  /* rest of your CSS here ... */
</style>
</head>
<body>

<h1>Study Routine Tracker (6 PM - 12 AM)</h1>
<div id="dateToday"></div>

<div class="tabs">
  <button class="tab-btn active" data-target="routine18">18-Day Routine</button>
  <button class="tab-btn" data-target="routine54">54-Day Routine</button>
</div>

<div id="routine18" class="routine-container">
  <h2>18-Day Study Routine</h2>
  <div class="grid" id="grid18"></div>
  <table id="table18">
    <thead>
      <tr>
        <th>Day</th>
        <th>Subject &amp; Time Duration</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="routine54" class="routine-container" style="display:none;">
  <h2>54-Day Study Routine</h2>
  <div class="grid" id="grid54"></div>
  <table id="table54">
    <thead>
      <tr>
        <th>Day</th>
        <th>Subject &amp; Time Duration</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<footer>&copy; 2025 Study Tracker</footer>

<script>
  // Your existing study routine code here (same as before) ...
  const subjectDurations = {
    'Nepali + English': { duration: 100, class: 'NepaliEnglish' },
    'English + Nepali': { duration: 100, class: 'EnglishNepali' },
    Account: { duration: 80, class: 'Account' },
    Science: { duration: 80, class: 'Science' },
    Economics: { duration: 80, class: 'Economics' },
    Social: { duration: 100, class: 'Social' },
    Math: { duration: 100, class: 'Math' },
  };

  function formatTime(date) {
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function generateSchedule(startHour, startMinute, subjects) {
    let schedule = [];
    let current = new Date();
    current.setHours(startHour, startMinute, 0, 0);
    for (let subj of subjects) {
      let dur = subjectDurations[subj]?.duration || 60;
      let end = new Date(current.getTime() + dur * 60000);
      schedule.push({
        subject: subj,
        start: formatTime(current),
        end: formatTime(end),
        startDate: new Date(current.getTime()),
        endDate: new Date(end.getTime()),
        cssClass: subjectDurations[subj]?.class || ''
      });
      current = end;
    }
    return schedule;
  }

  const routinePattern = [
    ['Nepali + English', 'Account', 'Science', 'Math'],
    ['Nepali + English', 'Social', 'Economics', 'Math'],
    ['English + Nepali', 'Account', 'Science', 'Math'],
  ];

  const routine18 = Array.from({length: 18}, (_, i) => routinePattern[i % 3]);
  const routine54 = Array.from({length: 54}, (_, i) => routinePattern[i % 3]);

  const start18Date = new Date();
  const start54Date = new Date();

  const dateTodayEl = document.getElementById('dateToday');
  const grid18 = document.getElementById('grid18');
  const grid54 = document.getElementById('grid54');
  const routine18Container = document.getElementById('routine18');
  const routine54Container = document.getElementById('routine54');
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tableBody18 = document.querySelector('#table18 tbody');
  const tableBody54 = document.querySelector('#table54 tbody');

  function getCurrentDayNumber(startDate, totalDays) {
    const now = new Date();
    const diff = now - startDate;
    const daysPassed = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
    if (daysPassed < 1) return 1;
    if (daysPassed > totalDays) return totalDays;
    return daysPassed;
  }

  function renderRoutineGrid(container, routine, storageKey, startDate) {
    container.innerHTML = '';
    const totalDays = routine.length;
    const todayNum = getCurrentDayNumber(startDate, totalDays);
    let completed = JSON.parse(localStorage.getItem(storageKey)) || [];

    for (let i = 0; i < totalDays; i++) {
      const dayNum = i + 1;
      const dayBox = document.createElement('div');
      dayBox.classList.add('day-box');
      if (completed.includes(dayNum)) dayBox.classList.add('completed');
      if (dayNum === todayNum) dayBox.classList.add('today');
      dayBox.textContent = dayNum;

      const now = new Date();
      let allowClick = false;
      const isToday = dayNum === todayNum;

      if (dayNum < todayNum) {
        allowClick = true;
      } else if (isToday) {
        const schedule = generateSchedule(18, 0, routine[i]);
        const lastEnd = schedule[schedule.length - 1].endDate;

        if (now >= lastEnd) {
          allowClick = true;
        } else {
          dayBox.classList.add('glowing');
        }
      }

      if (allowClick) {
        dayBox.classList.add('clickable');
        dayBox.addEventListener('click', () => {
          let comp = JSON.parse(localStorage.getItem(storageKey)) || [];
          if (comp.includes(dayNum)) {
            comp = comp.filter(d => d !== dayNum);
            dayBox.classList.remove('completed');
          } else {
            comp.push(dayNum);
            dayBox.classList.add('completed');
          }
          localStorage.setItem(storageKey, JSON.stringify(comp));
        });
      } else {
        dayBox.classList.add('disabled');
      }

      container.appendChild(dayBox);
    }
  }

  function renderRoutineTable(tbody, routine) {
    tbody.innerHTML = '';
    routine.forEach((subjects, idx) => {
      const tr = document.createElement('tr');
      const dayNum = idx + 1;
      const schedule = generateSchedule(18, 0, subjects);

      const subjWithTime = schedule.map(s => {
        return `<span class="subject-badge ${s.cssClass}">${s.subject} (${s.start} - ${s.end})</span>`;
      }).join('');

      tr.innerHTML = `<td>${dayNum}</td><td style="text-align:left;">${subjWithTime}</td>`;
      tbody.appendChild(tr);
    });
  }

  function updateDate() {
    const now = new Date();
    dateTodayEl.textContent = `Today is: ${now.toLocaleDateString(undefined, {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })}`;
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (btn.dataset.target === 'routine18') {
        routine18Container.style.display = 'block';
        routine54Container.style.display = 'none';
      } else {
        routine18Container.style.display = 'none';
        routine54Container.style.display = 'block';
      }
    });
  });

  updateDate();
  renderRoutineGrid(grid18, routine18, 'completed18', start18Date);
  renderRoutineGrid(grid54, routine54, 'completed54', start54Date);
  renderRoutineTable(tableBody18, routine18);
  renderRoutineTable(tableBody54, routine54);

  setInterval(() => {
    updateDate();
    renderRoutineGrid(grid18, routine18, 'completed18', start18Date);
    renderRoutineGrid(grid54, routine54, 'completed54', start54Date);
  }, 60000);

  // === IMPROVED NOTIFICATION SYSTEM WITH RANDOM & FIXED REMINDERS ===

  const reminderHours = [5, 7, 9, 11, 13, 15, 17];
  const reminderMinute = 0;

  const MAX_RANDOM_REMINDERS = 3;

  function getTodayKey(suffix) {
    return suffix + '_' + new Date().toISOString().split('T')[0];
  }

  const STOP_KEY = getTodayKey('stopReminders');
  const RANDOM_COUNT_KEY = getTodayKey('randomReminderCount');

  document.addEventListener("DOMContentLoaded", () => {
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
      Notification.requestPermission();
    }
  });

  function showNotification(message) {
    if (Notification.permission !== 'granted') return;

    const stopKey = STOP_KEY;

    const notification = new Notification("ðŸ“š Study Reminder", {
      body: message + " Click to stop reminders for today.",
      icon: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png",
      badge: "https://cdn-icons-png.flaticon.com/512/1827/1827392.png"
    });

    notification.onclick = () => {
      localStorage.setItem(stopKey, true);
      notification.close();
    };
  }

  function checkFixedReminders() {
    const now = new Date();
    const hour = now.getHours();
    const minute = now.getMinutes();

    if (localStorage.getItem(STOP_KEY)) return;

    if (
      reminderHours.includes(hour) &&
      (minute === reminderMinute || (hour === 17 && minute === 50))
    ) {
      showNotification("Get ready to study!");
    }
  }

  function scheduleRandomReminder() {
    if (localStorage.getItem(STOP_KEY)) return;

    let count = parseInt(localStorage.getItem(RANDOM_COUNT_KEY)) || 0;
    if (count >= MAX_RANDOM_REMINDERS) return;

    // Random delay 5 min to 3 hours
    const randomDelay = Math.floor(Math.random() * (3 * 60 - 5) + 5) * 60000;

    setTimeout(() => {
      if (localStorage.getItem(STOP_KEY)) return;

      showNotification("Hey! Time to get ready and study.");

      count++;
      localStorage.setItem(RANDOM_COUNT_KEY, count);

      if (count < MAX_RANDOM_REMINDERS) {
        scheduleRandomReminder();
      }
    }, randomDelay);
  }

  function initRandomReminders() {
    const lastDate = localStorage.getItem('randomReminderDate');
    const today = new Date().toISOString().split('T')[0];
    if (lastDate !== today) {
      localStorage.setItem(RANDOM_COUNT_KEY, 0);
      localStorage.setItem(STOP_KEY, false);
      localStorage.setItem('randomReminderDate', today);
    }
    scheduleRandomReminder();
  }

  setInterval(() => {
    checkFixedReminders();
  }, 60000);

  initRandomReminders();

</script>

</body>
</html>
